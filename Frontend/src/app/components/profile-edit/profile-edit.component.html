<div class="profile-edit-container">

  @if (loading){
    <div class="loading">Loading profile...</div>
  } @else if (error){
    <div class="error">{{ error }}</div>
  } @else if (userProfile){


  <div class="icon-upload-container">
    <h2>Profile image</h2>
    <div class="preview-container">
      <div class="icon-preview" [class.previewUrl]="previewUrl">
        @if(previewUrl){
            <img [src]="previewUrl" alt="Icon preview">
        } @else {
          <span>No image selected</span>
        }
      </div>
    </div>

    <div class="upload-controls">
      <input
        type="file"
        #fileInput
        (change)="onFileSelected($event)"
        accept="image/*"
        style="display: none">

      <button (click)="fileInput.click()" class="btn">
        Select Image
      </button>

      <button
        (click)="uploadIcon()"
        [disabled]="!previewUrl || uploading"
        class="btn">
        {{ uploading ? 'Uploading...' : 'Upload Icon' }}
      </button>

      @if(previewUrl){
        <button
          (click)="clearSelection()"
          class="btn red">
          Clear
        </button>
      }
    </div>

    <div class="messages">
      @if (uploadError){
        <p class="error">{{ uploadError }}</p>
      } @else if (uploadSuccess){
        <p class="success" >{{ uploadSuccess }}</p>
      }


    </div>

    <div class="upload-info">
      <small>Supported formats: PNG, JPG, GIF | Max size: 5MB</small>
    </div>
  </div>



  <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
    <h2>Profile Information</h2>
    <div class="form-section">
      <label for="name">First Name</label>
      <input
        type="text"
        id="name"
        formControlName="name"
        class="form-input input"
        [class.error]="getFieldError(profileForm, 'name')">
      @if (getFieldError(profileForm, 'name')) {
        <span class="error-message">{{ getFieldError(profileForm, 'name') }}</span>
      }
    </div>

    <div class="form-section">
      <label for="lastname">Last Name</label>
      <input
        type="text"
        id="lastname"
        formControlName="lastname"
        class="form-input input"
        [class.error]="getFieldError(profileForm, 'lastname')">
      @if (getFieldError(profileForm, 'lastname')) {
        <span class="error-message">{{ getFieldError(profileForm, 'lastname') }}</span>
      }
    </div>

    <div class="form-section">
      <label for="login">Username</label>
      <input
        type="text"
        id="login"
        formControlName="login"
        class="form-input input"
        [class.error]="getFieldError(profileForm, 'login')">
      @if (getFieldError(profileForm, 'login')) {
        <span class="error-message">{{ getFieldError(profileForm, 'login') }}</span>
      }
    </div>

    <div class="form-section">
      <label for="bio">Bio / Description</label>
      <textarea
        id="bio"
        formControlName="bio"
        class="form-input input"
        rows="4"
        placeholder="Tell us about yourself..."
        [class.error]="getFieldError(profileForm, 'bio')"></textarea>
      @if (getFieldError(profileForm, 'bio')) {
        <span class="error-message">{{ getFieldError(profileForm, 'bio') }}</span>
      }
      <small class="char-count">{{ profileForm.get('bio')?.value?.length || 0 }} / 500</small>
    </div>

    <div class="form-section">
      <label for="email">Email</label>
      <input
        type="email"
        id="email"
        formControlName="email"
        class="form-input input"
        [class.error]="getFieldError(profileForm, 'email')">
      @if (getFieldError(profileForm, 'email')) {
        <span class="error-message">{{ getFieldError(profileForm, 'email') }}</span>
      }
    </div>

    <button type="submit" class="btn btn-primary" [disabled]="saving || profileForm.invalid">
      {{ saving ? 'Saving...' : 'Save Profile' }}
    </button>

    @if (saveSuccess) {
      <p class="success-message">{{ saveSuccess }}</p>
    }
    @if (saveError) {
      <p class="error-message">{{ saveError }}</p>
    }
  </form>


<!--  TODO: use global input correct classes  -->

  <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="password-form">
    <h2>Change Password</h2>
    <div class="form-section">
      <label for="currentPassword">Current Password</label>
      <input
        type="password"
        id="currentPassword"
        formControlName="currentPassword"
        class="form-input input"
        [class.error]="getFieldError(passwordForm, 'currentPassword')">
      @if (getFieldError(passwordForm, 'currentPassword')) {
        <span class="error-message">{{ getFieldError(passwordForm, 'currentPassword') }}</span>
      }
    </div>

    <div class="form-section">
      <label for="newPassword">New Password</label>
      <input
        type="password"
        id="newPassword"
        formControlName="newPassword"
        class="form-input input"
        [class.error]="getFieldError(passwordForm, 'newPassword')">
      @if (getFieldError(passwordForm, 'newPassword')) {
        <span class="error-message">{{ getFieldError(passwordForm, 'newPassword') }}</span>
      }
    </div>

    <div class="form-section">
      <label for="confirmPassword">Confirm New Password</label>
      <input
        type="password"
        id="confirmPassword"
        formControlName="confirmPassword"
        class="form-input input"
        [class.error]="getFieldError(passwordForm, 'confirmPassword') || passwordMismatch">
      @if (getFieldError(passwordForm, 'confirmPassword')) {
        <span class="error-message">{{ getFieldError(passwordForm, 'confirmPassword') }}</span>
      }
      @if (passwordMismatch) {
        <span class="error-message">Passwords do not match</span>
      }
    </div>

    <button type="submit" class="btn btn-primary" [disabled]="saving || passwordForm.invalid">
      {{ saving ? 'Changing...' : 'Change Password' }}
    </button>
  </form>

  <h2>Privacy Settings</h2>
  <div class="privacy-container">
    <label>
      <input type="checkbox" [checked]="userProfile.isPrivate" (change)="togglePrivacy()">
      <span>Private Profile</span>
    </label>
    <div class="privacy-info">
      @if(userProfile.isPrivate){
        <small>Your profile is private - only you can view it</small>
      } @else {
        <small>Your profile is public - anyone can view it</small>
      }
    </div>
  </div>

  }
</div>
