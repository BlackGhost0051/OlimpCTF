<div class="tasks-view">
  <p-card>
    <ng-template pTemplate="header">
      <div class="flex justify-content-between align-items-center header-container">
        <h2>Tasks Management</h2>
        <p-button
          label="Add New Task"
          (onClick)="showAddDialog()">
        </p-button>
      </div>
    </ng-template>

    <p-table
      [value]="tasks"
      [loading]="loading"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 20]"
      dataKey="id"
      styleClass="p-datatable-striped">

      <ng-template pTemplate="header">
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Difficulty</th>
          <th>Points</th>
          <th>Description</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-task>
        <tr>
          <td>{{ task.title }}</td>
          <td>{{ task.category }}</td>
          <td>
            <p-tag
              [value]="task.difficulty | titlecase"
              [severity]="getDifficultyTag(task.difficulty)">
            </p-tag>
          </td>
          <td>{{ task.points }}</td>
          <td>{{ task.description?.substring(0, 50) }}{{ task.description && task.description.length > 50 ? '...' : '' }}</td>
          <td>{{ task.created_at | date:'short' }}</td>
          <td>
            <div class="flex gap-2">
              <p-button
                [text]="true"
                size="small"
                (onClick)="editTask(task)"
                label="Edit">
              </p-button>
              <p-button
                [text]="true"
                severity="danger"
                size="small"
                (onClick)="deleteTask(task)"
                label="Delete">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">No tasks found</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Edit Task Dialog -->
  <p-dialog
    [(visible)]="showDialog"
    [style]="{width: '450px'}"
    [header]="editMode ? 'Edit Task' : 'Add New Task'"
    [modal]="true"
    styleClass="p-fluid">
    <ng-template pTemplate="content">
      <div class="field">
        <label>Upload Mode</label>
        <div class="flex gap-3">
          <label class="flex align-items-center">
            <input
              type="radio"
              name="uploadMode"
              value="simple"
              [(ngModel)]="uploadMode"
              class="mr-2" />
            Simple Task
          </label>
          <label class="flex align-items-center">
            <input
              type="radio"
              name="uploadMode"
              value="zip"
              [(ngModel)]="uploadMode"
              class="mr-2" />
            ZIP Upload (Docker/Files)
          </label>
        </div>
      </div>

      @if(uploadMode === 'zip') {
        <div class="field">
          <label for="zip-file">Task ZIP File</label>
          <input
            type="file"
            id="zip-file"
            accept=".zip"
            (change)="onFileSelected($event)"
            class="p-inputtext" />
          @if(selectedZipFile) {
            <small class="text-success">Selected: {{ selectedZipFile.name }}</small>
          }
          <small class="text-muted">Task ID will be auto-generated (UUID)</small>
        </div>
      }

      <div class="field">
        <label for="title">Title</label>
        <input
          type="text"
          pInputText
          id="title"
          [(ngModel)]="editedTask.title"
          required
          autofocus />
      </div>

      <div class="field">
        <label for="category">Category</label>
        <input
          type="text"
          pInputText
          id="category"
          [(ngModel)]="editedTask.category"
          required />
      </div>

      <div class="field">
        <label for="difficulty">Difficulty</label>
        <select
          id="difficulty"
          [(ngModel)]="editedTask.difficulty"
          class="p-inputtext">
          <option value="">Select difficulty</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>

      <div class="field">
        <label for="points">Points</label>
        <input
          type="number"
          pInputText
          id="points"
          [(ngModel)]="editedTask.points"
          min="1" />
      </div>

      <div class="field">
        <label for="description">Description</label>
        <textarea
          id="description"
          class="p-inputtext"
          [(ngModel)]="editedTask.description"
          rows="3"
          cols="20">
        </textarea>
      </div>

      <div class="field">
        <label for="flag">Flag</label>
        <input
          type="text"
          pInputText
          id="flag"
          [(ngModel)]="flag"
          placeholder="Enter flag content" />

        <div class="flag-constructor">
          <p-button
            label="Add Random"
            (onClick)="addRandomToFlag()"
            styleClass="p-button-sm p-button-outlined">
          </p-button>

          @if(flag) {
            <div class="flag-preview">
              <span class="flag-text">Flag: <strong>{{ flagPrefix }}{{ flag }}{{ flagSuffix }}</strong></span>
            </div>
          }
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        [text]="true"
        (onClick)="hideDialog()">
      </p-button>
      <p-button
        [label]="editMode ? 'Update' : 'Save'"
        (onClick)="saveTask()">
      </p-button>
    </ng-template>
  </p-dialog>

</div>
